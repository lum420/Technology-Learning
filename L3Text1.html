<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¯¹å¤–æ±‰è¯­æ•™å­¦å¹³å°</title>
<style>
:root{--bg:#f3f9ff;--card:#fff;--accent:#3b82f6;--muted:#374151;--danger:#ef4444}
body{font-family:"Microsoft YaHei",Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
.wrap{max-width:1100px;margin:0 auto}
.card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
h1,h2{margin:0 0 10px}
.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.hidden{display:none}
.options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.opt{padding:12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;color:#000;cursor:pointer}
.opt.correct{background:#d1fae5;border-color:#10b981}
.opt.wrong{background:#fee2e2;border-color:#ef4444}
.word-big{font-size:36px;margin:10px 0}
input,select,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d1d5db;color:#000}
button{cursor:pointer;background:var(--accent);color:#fff;border:none}
.btn-danger{background:var(--danger)}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:8px;border:1px solid #d1d5db;text-align:left}
.level-badge{display:inline-block;padding:4px 8px;background:#eef2ff;border-radius:6px;margin-right:6px}
.flex{display:flex;gap:12px;align-items:center}
.search{margin-bottom:8px}
.small{font-size:13px;color:var(--muted)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <!-- ç™»å½•å¡ -->
  <div class="card" id="loginCard">
    <h1>å¯¹å¤–æ±‰è¯­æ•™å­¦å¹³å°</h1>
    <div class="row">
      <div style="flex:1">
        <label>å§“å / å­¦å·</label><br>
        <input id="studentName" placeholder="ä¾‹å¦‚ï¼šKota / S12345">
      </div>
      <div style="width:180px">
        <label>è§’è‰²</label><br>
        <select id="roleSelect">
          <option value="student">å­¦ç”Ÿ</option>
          <option value="teacher">æ•™å¸ˆ</option>
        </select>
      </div>
      <div style="width:160px;margin-top:18px">
        <button id="loginBtn">ç™»å…¥</button>
      </div>
    </div>
    <div id="teacherPasswordDiv" class="hidden" style="margin-top:10px">
      <label>æ•™å¸ˆå¯†ç ï¼š</label>
      <input id="teacherPassword" type="password" placeholder="è¯·è¾“å…¥æ•™å¸ˆå¯†ç ">
    </div>
    <p class="small" style="margin-top:8px">æç¤ºï¼šæ•™å¸ˆç‚¹ã€Œæ•™å¸ˆæ¨¡å¼ã€å¯æŸ¥çœ‹å­¦ç”Ÿæˆç»©åå°ï¼ˆä¸¤é¡µé¢æ¨¡å¼ï¼‰ã€‚</p>
  </div>

  <!-- ä¸»ç•Œé¢å¡ -->
  <div class="card hidden" id="mainCard">
    <div class="row" style="justify-content:space-between">
      <div>
        <strong id="welcome"></strong> (<span id="roleTag"></span>)
      </div>
      <div class="toolbar">
        <button id="logoutBtn" class="btn-danger">ç™»å‡º</button>
        <button id="teacherModeBtn" class="hidden" style="background:#fbbf24;color:#000">æ•™å¸ˆæ¨¡å¼</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <label>é¢˜å‹ï¼š</label>
      <select id="gameType">
        <option value="mc">çœ‹è¯é€‰ä¹‰</option>
        <option value="typing">æ‹¼å†™/è¾“å…¥</option>
        <option value="listen">å¬å†™</option>
        <option value="match">é…å¯¹</option>
        <option value="pair">è¿è¿çœ‹</option>
      </select>
      <label>å…³å¡ï¼š</label>
      <select id="levelSelect"></select>
      <button id="startGameBtn">å¼€å§‹é—¯å…³</button>
    </div>

    <div id="gameArea" style="margin-top:12px"></div>

    <div id="resultArea" class="hidden">
      <h3>æœ¬æ¬¡å¾—åˆ†ï¼š<span id="sessionScore"></span></h3>
      <div class="row">
        <button id="retryBtn">é‡ç©æœ¬å…³</button>
      </div>
    </div>
  </div>

  <!-- æ•™å¸ˆåå°ï¼ˆä¸¤é¡µé¢ï¼šæ¦‚è§ˆ -> å­¦ç”Ÿè¯¦æƒ…ï¼‰ -->
  <div class="card hidden" id="teacherCard">
    <div id="teacherOverview">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>æ•™å¸ˆåå° â€” å­¦ç”Ÿæ€»è§ˆ</h2>
        <div class="flex">
          <input id="searchStudent" class="search" placeholder="æœç´¢å­¦ç”Ÿå§“å">
          <button id="exportAllCsvBtn">å¯¼å‡ºå…¨ç­ CSV</button>
          <button id="clearScoresBtn" class="btn-danger">æ¸…ç©ºæ‰€æœ‰æˆç»©</button>
        </div>
      </div>
      <div id="studentsListArea" style="margin-top:12px"></div>
    </div>

    <div id="teacherStudentDetail" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <button id="backToOverview" style="background:#94a3b8">â† è¿”å›æ€»è§ˆ</button>
          <strong id="detailStudentName" style="margin-left:12px"></strong>
          <div id="studentProgressSummary" class="small" style="margin-top:6px"></div>
        </div>
        <div class="flex">
          <button id="exportOneCsvBtn">å¯¼å‡ºè¯¥å­¦ç”Ÿ CSV</button>
          <button id="deleteStudentScoresBtn" class="btn-danger">åˆ é™¤è¯¥å­¦ç”Ÿæˆç»©</button>
        </div>
      </div>

      <div id="studentScoresTable" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   é…ç½®ä¸æ•°æ®å­˜å‚¨è¯´æ˜
   - æˆç»©å­˜åœ¨ localStorage key: cf_scores ï¼ˆæ•°ç»„ï¼‰
   - è¿›åº¦å­˜åœ¨ localStorage key: cf_progressï¼ˆå¯¹è±¡ï¼šæŒ‰å­¦ç”Ÿï¼‰
   - å¦‚æœæƒ³æ¯æ¬¡ç”¨ä¸åŒç»ƒä¹ åï¼Œè¯·æŠŠæ–‡ä»¶åä½œä¸º exercise åç§°
   ============================ */

const EXERCISE_NAME = location.pathname.split('/').pop().replace('.html','') || 'L1Text2';
const TEACHER_PASSWORD = 'NK0811';
const correctSound = new Audio('correct.mp3');
const wrongSound = new Audio('wrong.mp3');

// å…³å¡æ•°æ®ï¼ˆç¤ºä¾‹ï¼Œå¯æ‰©å……ï¼‰
const LEVELS = [
  { name: 'PART1: å®¶äºº', words:[
    {ch:'çˆ¸çˆ¸',pin:'bÃ ba',en:'father'},
    {ch:'å¦ˆå¦ˆ',pin:'mÄma',en:'mother'},
    {ch:'å“¥å“¥',pin:'gÄ“ge',en:'older brother'},
    {ch:'å§å§',pin:'jiÄ›jie',en:'older sister'},
    {ch:'å¼Ÿå¼Ÿ',pin:'dÃ¬di',en:'younger brother'},
    {ch:'å¦¹å¦¹',pin:'mÃ¨imei',en:'younger sister'}
  ]},
  { name: 'PART2: äº²æˆš', words:[
    {ch:'çˆ·çˆ·',pin:'yÃ©ye',en:'grandfather'},
    {ch:'å¥¶å¥¶',pin:'nÇinai',en:'grandmother'},
    {ch:'å”å”',pin:'shÅ«shu',en:'uncle'},
    {ch:'å§‘å§‘',pin:'gÅ«gu',en:'aunt'}
  ]}
];

let scores = JSON.parse(localStorage.getItem('cf_scores') || '[]'); // array of score objects
let progress = JSON.parse(localStorage.getItem('cf_progress') || '{}'); // { studentName: {levelIndex, levelName, gameType} }
let currentUser = null;
let currentSession = null;

/* ====== DOM ====== */
const loginCard = document.getElementById('loginCard');
const mainCard = document.getElementById('mainCard');
const teacherCard = document.getElementById('teacherCard');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const studentNameEl = document.getElementById('studentName');
const roleSelect = document.getElementById('roleSelect');
const welcomeEl = document.getElementById('welcome');
const roleTag = document.getElementById('roleTag');
const teacherModeBtn = document.getElementById('teacherModeBtn');
const gameTypeEl = document.getElementById('gameType');
const levelSelectEl = document.getElementById('levelSelect');
const startGameBtn = document.getElementById('startGameBtn');
const gameArea = document.getElementById('gameArea');
const resultArea = document.getElementById('resultArea');
const sessionScoreEl = document.getElementById('sessionScore');
const retryBtn = document.getElementById('retryBtn');
const teacherPasswordDiv = document.getElementById('teacherPasswordDiv');
const teacherPasswordInput = document.getElementById('teacherPassword');

const teacherOverview = document.getElementById('teacherOverview');
const studentsListArea = document.getElementById('studentsListArea');
const searchStudent = document.getElementById('searchStudent');
const exportAllCsvBtn = document.getElementById('exportAllCsvBtn');
const clearScoresBtn = document.getElementById('clearScoresBtn');

const teacherStudentDetail = document.getElementById('teacherStudentDetail');
const backToOverview = document.getElementById('backToOverview');
const detailStudentName = document.getElementById('detailStudentName');
const studentProgressSummary = document.getElementById('studentProgressSummary');
const studentScoresTable = document.getElementById('studentScoresTable');
const exportOneCsvBtn = document.getElementById('exportOneCsvBtn');
const deleteStudentScoresBtn = document.getElementById('deleteStudentScoresBtn');

/* ====== åˆå§‹åŒ–ä¸‹æ‹‰å…³å¡ ====== */
function initLevels(){
  levelSelectEl.innerHTML = '';
  LEVELS.forEach((l,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = l.name;
    levelSelectEl.appendChild(opt);
  });
}
initLevels();

/* ====== ç™»å½•é€»è¾‘ ====== */
roleSelect.onchange = ()=> teacherPasswordDiv.classList.toggle('hidden', roleSelect.value !== 'teacher');

loginBtn.onclick = ()=>{
  const name = studentNameEl.value.trim();
  const role = roleSelect.value;
  if(!name){ alert('è¯·è¾“å…¥å§“å / å­¦å·'); return; }
  if(role === 'teacher'){
    const pwd = teacherPasswordInput.value.trim();
    if(!pwd){ alert('è¯·è¾“å…¥æ•™å¸ˆå¯†ç '); return; }
    if(pwd !== TEACHER_PASSWORD){ alert('æ•™å¸ˆå¯†ç é”™è¯¯'); return; }
  }
  currentUser = { name, role };
  loginCard.classList.add('hidden');
  mainCard.classList.remove('hidden');
  welcomeEl.textContent = name;
  roleTag.textContent = role;
  if(role === 'teacher') teacherModeBtn.classList.remove('hidden');

  // æç¤ºæœªå®Œæˆè¿›åº¦
  if(role === 'student' && progress[name]){
    const p = progress[name];
    alert(`æ£€æµ‹åˆ°æœªå®Œæˆçš„å…³å¡ï¼š${p.levelName}ï¼Œé¢˜å‹ï¼š${p.gameType}ï¼Œå»ºè®®ç»§ç»­ã€‚`);
    levelSelectEl.value = p.levelIndex;
    gameTypeEl.value = p.gameType;
  }
};

logoutBtn.onclick = ()=> location.reload();

/* ====== æ•™å¸ˆåå° ä¸¤é¡µé¢æ¨¡å¼ ====== */
teacherModeBtn.onclick = ()=>{
  teacherCard.classList.toggle('hidden');
  if(!teacherCard.classList.contains('hidden')){
    // show overview by default
    showTeacherOverview();
  }
};

function showTeacherOverview(){
  teacherOverview.classList.remove('hidden');
  teacherStudentDetail.classList.add('hidden');
  renderStudentsOverview();
}

backToOverview.onclick = ()=>{
  showTeacherOverview();
};

/* ====== å­¦ç”Ÿåˆ—è¡¨ï¼ˆæ¦‚è§ˆï¼‰ ====== */
function getAllStudentsFromScores(){
  const set = new Set();
  scores.forEach(s=> set.add(s.student));
  // also include students with saved progress but no scores yet
  Object.keys(progress).forEach(n=> set.add(n));
  return Array.from(set).sort((a,b)=> a.localeCompare(b,'zh-Hans'));
}

function renderStudentsOverview(filterText=''){
  const students = getAllStudentsFromScores().filter(n => n.toLowerCase().includes(filterText.toLowerCase()));
  if(students.length === 0){
    studentsListArea.innerHTML = '<p class="small">æš‚æ— å­¦ç”Ÿæˆç»©æˆ–è¿›åº¦è®°å½•ã€‚</p>';
    return;
  }

  let html = `<table class="table"><thead><tr><th>å­¦ç”Ÿ</th><th>å®Œæˆç»ƒä¹ æ•°</th><th>æœ€æ–°å®Œæˆæ—¶é—´</th><th>æœ€è¿‘ç»ƒä¹ </th><th>æ“ä½œ</th></tr></thead><tbody>`;
  students.forEach(name=>{
    const sList = scores.filter(s=> s.student === name);
    const cnt = sList.length;
    const latest = sList.length ? sList.slice().sort((a,b)=> new Date(b.time) - new Date(a.time))[0].time : (progress[name] ? 'æœªå®Œæˆè¿›åº¦' : 'â€”');
    const lastExercise = sList.length ? sList.slice().sort((a,b)=> new Date(b.time) - new Date(a.time))[0].exercise : (progress[name] ? progress[name].levelName : 'â€”');
    html += `<tr>
      <td>${name}</td>
      <td>${cnt}</td>
      <td>${latest || 'â€”'}</td>
      <td>${lastExercise}</td>
      <td><button class="viewBtn" data-name="${name}">æŸ¥çœ‹è¯¦æƒ…</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  studentsListArea.innerHTML = html;

  // attach handlers for view buttons
  Array.from(document.getElementsByClassName('viewBtn')).forEach(b=>{
    b.onclick = ()=> openStudentDetail(b.dataset.name);
  });
}

/* æœç´¢ */
searchStudent.addEventListener('input', ()=> {
  renderStudentsOverview(searchStudent.value.trim());
});

/* ====== æ‰“å¼€å­¦ç”Ÿè¯¦æƒ…é¡µ ====== */
function openStudentDetail(name){
  teacherOverview.classList.add('hidden');
  teacherStudentDetail.classList.remove('hidden');
  detailStudentName.textContent = name;
  renderStudentDetail(name);
}

/* æ¸²æŸ“å­¦ç”Ÿè¯¦æƒ…ï¼šæˆç»©è¡¨ + å…³å¡è¿›åº¦æ±‡æ€» */
function renderStudentDetail(name){
  // student scores
  const sList = scores.filter(s=> s.student === name).slice().sort((a,b)=> new Date(b.time) - new Date(a.time));
  if(sList.length === 0){
    studentScoresTable.innerHTML = `<p class="small">è¯¥å­¦ç”Ÿå°šæ— å®Œæˆè®°å½•ã€‚</p>`;
  } else {
    let html = `<table class="table"><thead><tr><th>ç»ƒä¹ </th><th>å…³å¡</th><th>é¢˜å‹</th><th>å¾—åˆ†</th><th>æ€»åˆ†</th><th>æ—¶é—´</th></tr></thead><tbody>`;
    sList.forEach(s=>{
      html += `<tr>
        <td>${s.exercise}</td>
        <td>${s.level}</td>
        <td>${s.type}</td>
        <td>${s.score}</td>
        <td>${s.total}</td>
        <td>${s.time}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    studentScoresTable.innerHTML = html;
  }

  // progress summary by level (show latest score per level)
  const byLevel = {};
  sList.forEach(s=>{
    if(!byLevel[s.level]) byLevel[s.level] = [];
    byLevel[s.level].push(s);
  });
  let progHtml = '';
  LEVELS.forEach((lvl, idx)=>{
    const arr = byLevel[lvl.name] || [];
    if(arr.length === 0){
      progHtml += `<div><span class="level-badge">${lvl.name}</span> æœªå®Œæˆ</div>`;
    } else {
      const latest = arr.slice().sort((a,b)=> new Date(b.time) - new Date(a.time))[0];
      progHtml += `<div><span class="level-badge">${lvl.name}</span> ${latest.score}/${latest.total} ï¼ˆæœ€è¿‘ï¼š${latest.time}ï¼‰</div>`;
    }
  });
  // also include progress saved but not completed
  if(progress[name]){
    progHtml += `<div style="margin-top:6px" class="small">æœ¬åœ°æœªå®Œæˆè¿›åº¦ï¼š${progress[name].levelName} (${progress[name].gameType})</div>`;
  }
  studentProgressSummary.innerHTML = progHtml;
}

/* ====== å¯¼å‡º CSVï¼ˆå…¨ç­ / å•ä¸ªå­¦ç”Ÿï¼‰ ====== */
exportAllCsvBtn.onclick = ()=>{
  if(scores.length === 0){ alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º'); return; }
  const header = ['ç»ƒä¹ ','å­¦ç”Ÿ','è§’è‰²','å…³å¡','é¢˜å‹','å¾—åˆ†','æ€»åˆ†','æ—¶é—´'];
  const rows = scores.map(s => [s.exercise, s.student, s.role, s.level, s.type, s.score, s.total, s.time]);
  downloadCsv([header, ...rows], 'all_scores.csv');
};

exportOneCsvBtn.onclick = ()=>{
  const name = detailStudentName.textContent;
  const rows = scores.filter(s=> s.student === name).map(s=> [s.exercise,s.student,s.role,s.level,s.type,s.score,s.total,s.time]);
  if(rows.length === 0){ alert('è¯¥å­¦ç”Ÿæš‚æ— è®°å½•'); return; }
  const header = ['ç»ƒä¹ ','å­¦ç”Ÿ','è§’è‰²','å…³å¡','é¢˜å‹','å¾—åˆ†','æ€»åˆ†','æ—¶é—´'];
  downloadCsv([header, ...rows], `${name}_scores.csv`);
};

function downloadCsv(tableArray, filename){
  const csv = tableArray.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ====== åˆ é™¤å­¦ç”Ÿæˆç»© ====== */
deleteStudentScoresBtn.onclick = ()=>{
  const name = detailStudentName.textContent;
  if(!confirm(`ç¡®å®šåˆ é™¤ ${name} çš„æ‰€æœ‰æˆç»©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
  scores = scores.filter(s=> s.student !== name);
  localStorage.setItem('cf_scores', JSON.stringify(scores));
  renderStudentsOverview(searchStudent.value.trim());
  showTeacherOverview();
};

/* ====== æ¸…ç©ºæ‰€æœ‰æˆç»©æŒ‰é’®ï¼ˆæ¦‚è§ˆé¡µï¼‰ ====== */
clearScoresBtn.onclick = ()=>{
  if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æˆç»©ä¸è¿›åº¦å—ï¼Ÿ')) return;
  scores = []; progress = {};
  localStorage.removeItem('cf_scores');
  localStorage.removeItem('cf_progress');
  renderStudentsOverview();
  renderLevelStats();
};

/* ====== åˆ†å…³ç»Ÿè®¡ï¼ˆæ•™å¸ˆæ¦‚è§ˆé‡Œæ˜¾ç¤ºï¼‰ ====== */
function renderLevelStats(){
  // Optional: show average per level below students list (kept small)
  // We'll update students overview to include per-level stats area if desired.
}

/* ====== å·¥å…·ï¼šä¹±åºã€éšæœºã€å‘éŸ³ ====== */
function shuffle(arr){ return arr.sort(()=> Math.random() - 0.5); }
function randomFrom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
function speak(text){ const msg = new SpeechSynthesisUtterance(text); msg.lang = 'zh-CN'; window.speechSynthesis.speak(msg); }

/* ====== å¼€å§‹å…³å¡ä¸æ¸²æŸ“æ¸¸æˆ ====== */
startGameBtn.onclick = ()=> {
  if(!currentUser){ alert('è¯·å…ˆç™»å…¥'); return; }
  startSession(parseInt(levelSelectEl.value), gameTypeEl.value);
};

function startSession(levelIndex, gameType){
  const lvl = LEVELS[levelIndex];
  const words = shuffle([...lvl.words]);
  currentSession = {
    levelIndex,
    levelName: lvl.name,
    gameType,
    words: words.slice(0,4),
    score: 0,
    total: Math.min(4, words.length)
  };
  // ä¿å­˜è¿›åº¦ï¼ˆæœªå®Œæˆï¼‰
  progress[currentUser.name] = { levelIndex, levelName: lvl.name, gameType };
  localStorage.setItem('cf_progress', JSON.stringify(progress));
  renderGame();
}

function renderGame(){
  gameArea.innerHTML = '';
  resultArea.classList.add('hidden');
  const { gameType, words } = currentSession;
  if(gameType === 'mc') renderMC(words);
  else if(gameType === 'typing') renderTyping(words);
  else if(gameType === 'listen') renderListen(words);
  else if(gameType === 'match') renderMatch(words);
  else if(gameType === 'pair') renderPair(words);
}

/* ====== é¢˜å‹å®ç°ï¼ˆMC / Typing / Listen / Match / Pairï¼‰ ====== */

// çœ‹è¯é€‰ä¹‰
function renderMC(words){
  let idx = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">çœ‹è¯é€‰ä¹‰ (${words.length} é¢˜)</div>`;
  gameArea.appendChild(box);

  const showQ = ()=>{
    box.querySelectorAll('.q').forEach(n=> n.remove());
    if(idx >= words.length){ finishSession(); return; }
    const w = words[idx];
    const q = document.createElement('div'); q.className = 'q';
    q.innerHTML = `<div class="word-big">${w.ch}</div><div class="muted">${w.pin}</div>`;
    const opts = [w.en];
    while(opts.length < 4){ const r = randomFrom(words).en; if(!opts.includes(r)) opts.push(r); }
    shuffle(opts);
    const optsBox = document.createElement('div'); optsBox.className = 'options';
    opts.forEach(o=>{
      const b = document.createElement('button'); b.className = 'opt'; b.textContent = o;
      b.onclick = ()=>{
        if(o === w.en){ b.classList.add('correct'); correctSound.play().catch(()=>{}); currentSession.score++; }
        else{ b.classList.add('wrong'); wrongSound.play().catch(()=>{}); const right = [...optsBox.children].find(x=> x.textContent === w.en); if(right) right.classList.add('correct'); }
        idx++; setTimeout(showQ,600);
      };
      optsBox.appendChild(b);
    });
    const speakBtn = document.createElement('button'); speakBtn.textContent = 'ğŸ”Š å‘éŸ³'; speakBtn.style.marginLeft='8px';
    speakBtn.onclick = ()=> speak(w.ch);
    q.appendChild(speakBtn);
    q.appendChild(optsBox);
    box.appendChild(q);
  };
  showQ();
}

// æ‹¼å†™/è¾“å…¥
function renderTyping(words){
  let idx = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">æ‹¼å†™/è¾“å…¥ (${words.length} é¢˜)</div>`;
  gameArea.appendChild(box);

  const showQ = ()=>{
    box.querySelectorAll('.q').forEach(n=> n.remove());
    if(idx >= words.length){ finishSession(); return; }
    const w = words[idx];
    const q = document.createElement('div'); q.className = 'q';
    q.innerHTML = `<div class="word-big">${w.ch}</div><div class="muted">${w.pin}</div>`;
    const inp = document.createElement('input'); inp.style.width='100%'; inp.placeholder='è¾“å…¥ç­”æ¡ˆå¹¶å›è½¦';
    inp.onkeydown = (e)=>{
      if(e.key === 'Enter'){
        const val = inp.value.trim().toLowerCase();
        if(val === w.ch.toLowerCase() || val === w.en.toLowerCase() || val === w.pin.toLowerCase()){
          currentSession.score++; correctSound.play().catch(()=>{});
        } else { wrongSound.play().catch(()=>{}); }
        idx++; setTimeout(showQ,600);
      }
    };
    q.appendChild(inp); box.appendChild(q); inp.focus();
  };
  showQ();
}

// å¬å†™
function renderListen(words){
  let idx = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">å¬å†™ (${words.length} é¢˜)</div>`;
  gameArea.appendChild(box);

  const showQ = ()=>{
    box.querySelectorAll('.q').forEach(n=> n.remove());
    if(idx >= words.length){ finishSession(); return; }
    const w = words[idx];
    const q = document.createElement('div'); q.className = 'q';
    const playBtn = document.createElement('button'); playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
    playBtn.onclick = ()=> speak(w.ch);
    q.appendChild(playBtn);
    const inp = document.createElement('input'); inp.style.width='100%'; inp.placeholder='è¾“å…¥ç­”æ¡ˆå¹¶å›è½¦';
    inp.onkeydown = (e)=>{
      if(e.key === 'Enter'){
        const val = inp.value.trim().toLowerCase();
        if(val === w.ch.toLowerCase() || val === w.en.toLowerCase() || val === w.pin.toLowerCase()){
          currentSession.score++; correctSound.play().catch(()=>{});
        } else { wrongSound.play().catch(()=>{}); }
        idx++; setTimeout(showQ,600);
      }
    };
    q.appendChild(inp); box.appendChild(q); inp.focus();
  };
  showQ();
}

// é…å¯¹
function renderMatch(words){
  currentSession.score = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">é…å¯¹é¢˜ï¼šç‚¹å‡»å·¦åˆ—ä¸­æ–‡ï¼Œå†ç‚¹å‡»å³åˆ—è‹±æ–‡</div>`;
  gameArea.appendChild(box);
  let selected = null, correctPairs = 0;
  const left = words.map(w=> ({ id: w.ch, text: w.ch }));
  const right = shuffle(words.map(w=> ({ id: w.ch, text: w.en })));
  const leftBox = document.createElement('div'); leftBox.style.width='45%'; leftBox.style.display='inline-block';
  const rightBox = document.createElement('div'); rightBox.style.width='45%'; rightBox.style.display='inline-block';
  left.forEach(l=>{
    const b = document.createElement('button'); b.className='opt'; b.style.display='block'; b.style.width='100%'; b.style.marginBottom='6px'; b.textContent=l.text;
    b.onclick = ()=> { selected = l; b.style.border = '2px solid #3b82f6'; };
    leftBox.appendChild(b);
  });
  right.forEach(r=>{
    const b = document.createElement('button'); b.className='opt'; b.style.display='block'; b.style.width='100%'; b.style.marginBottom='6px'; b.textContent=r.text;
    b.onclick = ()=>{
      if(!selected){ alert('å…ˆé€‰å·¦åˆ—'); return; }
      const correct = words.find(w=> w.ch === selected.id).en;
      if(r.text === correct){ b.classList.add('correct'); correctSound.play().catch(()=>{}); currentSession.score++; correctPairs++; }
      else { b.classList.add('wrong'); wrongSound.play().catch(()=>{}); }
      selected = null;
      if(correctPairs >= words.length) finishSession();
    };
    rightBox.appendChild(b);
  });
  box.appendChild(leftBox); box.appendChild(rightBox);
}

// è¿è¿çœ‹
function renderPair(words){
  currentSession.score = 0;
  const box = document.createElement('div');
  box.innerHTML = `<div class="small muted">è¿è¿çœ‹ï¼šç‚¹å‡»ä¸€é¡¹ï¼Œå†ç‚¹å‡»åŒ¹é…é¡¹</div>`;
  gameArea.appendChild(box);
  let first = null, pairs = 0;
  const items = shuffle(words.flatMap(w=> [{ type:'ch', key:w.ch, text:w.ch }, { type:'en', key:w.ch, text:w.en }]));
  const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(4,1fr)'; grid.style.gap='8px';
  items.forEach(it=>{
    const b = document.createElement('button'); b.className='opt'; b.textContent = it.text;
    b.onclick = ()=>{
      if(!first){ first = it; b.style.opacity = 0.5; return; }
      if(first.key === it.key && first.type !== it.type){
        currentSession.score++; correctSound.play().catch(()=>{}); pairs++;
        // hide both items (by text match)
        Array.from(grid.children).forEach(n=> { if(n.textContent === first.text || n.textContent === it.text) n.style.visibility = 'hidden'; });
      } else { wrongSound.play().catch(()=>{}); alert('ä¸æ˜¯é…å¯¹ï¼Œé‡é€‰'); }
      first = null;
      if(pairs >= words.length) finishSession();
    };
    grid.appendChild(b);
  });
  box.appendChild(grid);
}

/* ====== å®Œæˆå…³å¡ï¼šè®°å½•æˆç»©ï¼Œæ¸…é™¤è¿›åº¦ ====== */
function finishSession(){
  currentSession.timestamp = new Date().toLocaleString();
  sessionScoreEl.textContent = `${currentSession.score} / ${currentSession.total}`;
  resultArea.classList.remove('hidden');

  const rec = {
    exercise: EXERCISE_NAME,
    student: currentUser.name,
    role: currentUser.role,
    level: currentSession.levelName,
    type: currentSession.gameType,
    score: currentSession.score,
    total: currentSession.total,
    time: currentSession.timestamp
  };
  scores.push(rec);
  localStorage.setItem('cf_scores', JSON.stringify(scores));

  // åˆ é™¤è¿›åº¦
  delete progress[currentUser.name];
  localStorage.setItem('cf_progress', JSON.stringify(progress));
}

/* é‡ç© */
retryBtn.onclick = ()=> {
  if(currentSession) startSession(currentSession.levelIndex, currentSession.gameType);
};

/* æ¯æ¬¡æ‰“å¼€æ•™å¸ˆæ¦‚è§ˆæ—¶åˆ·æ–°åˆ—è¡¨ */
function refreshTeacherView(){
  if(!teacherCard.classList.contains('hidden')) renderStudentsOverview(searchStudent.value.trim());
}

/* é¡µé¢ç¦»å¼€/è¿›å…¥è‡ªåŠ¨åˆ·æ–° overview */
window.addEventListener('storage', ()=> {
  scores = JSON.parse(localStorage.getItem('cf_scores') || '[]');
  progress = JSON.parse(localStorage.getItem('cf_progress') || '{}');
  refreshTeacherView();
});

/* é¡µé¢åŠ è½½æ—¶ render overview if teacherCard open */
document.addEventListener('visibilitychange', ()=> {
  refreshTeacherView();
});

/* åˆæ¬¡æ¸²æŸ“å­¦ç”Ÿæ¦‚è§ˆï¼ˆè‹¥å·²ç™»å…¥ä¸ºæ•™å¸ˆï¼‰ */
if(currentUser && currentUser.role === 'teacher') renderStudentsOverview('');

/* ====== ç»“æŸ ====== */
</script>
</body>
</html>
