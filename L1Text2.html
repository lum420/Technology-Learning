<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>对外汉语教学平台</title>
<style>
:root{--bg:#f3f9ff;--card:#ffffff;--accent:#3b82f6;--muted:#374151}
body{font-family:"Microsoft YaHei",Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111;}
.wrap{max-width:1000px;margin:auto}
.card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 4px 15px rgba(0,0,0,.1);color:#000;}
h1,h2{margin:0 0 10px}
.muted{color:var(--muted);font-size:13px}
input,select,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d1d5db;color:#000}
button{cursor:pointer;background:var(--accent);color:#fff;border:none}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.hidden{display:none}
.options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.opt{padding:12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;color:#000;cursor:pointer}
.opt.correct{background:#d1fae5;border-color:#10b981}
.opt.wrong{background:#fee2e2;border-color:#ef4444}
.word-big{font-size:36px;margin:10px 0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border:1px solid #d1d5db;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <!-- 登录 -->
  <div class="card" id="loginCard">
    <h1>登录</h1>
    <div class="row">
      <div style="flex:1">
        <label>姓名 / 学号</label><br>
        <input id="studentName" placeholder="例如：Kota / S12345">
      </div>
      <div style="width:160px">
        <label>角色</label><br>
        <select id="roleSelect">
          <option value="student">学生</option>
          <option value="teacher">教师</option>
        </select>
      </div>
      <div style="width:160px;margin-top:18px">
        <button id="loginBtn">登入</button>
      </div>
    </div>
    <div id="teacherPasswordDiv" class="hidden" style="margin-top:8px">
      <label>教师密码：</label><input id="teacherPassword" type="password" placeholder="请输入密码">
    </div>
  </div>

  <!-- 游戏主界面 -->
  <div class="card hidden" id="mainCard">
    <div class="row" style="justify-content:space-between">
      <div><span id="welcome" style="font-weight:700"></span> (<span id="roleTag"></span>)</div>
      <div class="row">
        <button id="logoutBtn" style="background:#ef4444">登出</button>
        <button id="teacherModeBtn" class="hidden" style="background:#fbbf24;color:#000">教师模式</button>
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <label>题型：</label>
      <select id="gameType">
        <option value="mc">看词选义</option>
        <option value="typing">拼写/输入</option>
        <option value="listen">听写</option>
        <option value="match">配对</option>
        <option value="pair">连连看</option>
      </select>
      <label>关卡：</label>
      <select id="levelSelect"></select>
      <button id="startGameBtn">开始闯关</button>
    </div>

    <div id="gameArea" style="margin-top:12px"></div>
    <div id="resultArea" class="hidden">
      <h3>本次得分：<span id="sessionScore"></span></h3>
      <button id="retryBtn">重玩本关</button>
    </div>
  </div>

  <!-- 教师界面 -->
  <div class="card hidden" id="teacherCard">
    <h2>教师批改与成绩管理</h2>
    <button id="exportCsvBtn">导出 CSV</button>
    <button id="clearScoresBtn" style="background:#ef4444;margin-left:10px;">清空成绩</button>
    <div id="teacherTable"></div>
  </div>
</div>

<script>
// --- 新增：练习名字 ---
const EXERCISE_NAME = "L1Text2";

// 教师密码
const TEACHER_PASSWORD = "NK0811";

// 关卡与词汇
const LEVELS = [
  {name:'HSK1: 基础', words:[
    {ch:'再见', pin:'zàijiàn', en:'goodbye'},
    {ch:'不客气', pin:'bú kèqi', en:'you’re welcome'},
    {ch:'对不起', pin:'duìbuqǐ', en:'sorry'},
    {ch:'很好', pin:'hěn hǎo', en:'very good'},
    {ch:'不好', pin:'bù hǎo', en:'not good'},
    {ch:'喜欢', pin:'xǐhuān', en:'like'},
  ]},
  {name:'HSK2: 人物与活动', words:[
    {ch:'学习', pin:'xuéxí', en:'study'},
    {ch:'爸爸', pin:'bàba', en:'father'},
    {ch:'老师', pin:'lǎoshī', en:'teacher'},
    {ch:'运动', pin:'yùndòng', en:'exercise/sport'},
    {ch:'唱歌', pin:'chàng gē', en:'sing'}
  ]}
];

let scores = JSON.parse(localStorage.getItem('cf_scores')||'[]');

// 元素
const loginCard = document.getElementById('loginCard');
const mainCard = document.getElementById('mainCard');
const teacherCard = document.getElementById('teacherCard');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const studentNameEl = document.getElementById('studentName');
const roleSelect = document.getElementById('roleSelect');
const welcomeEl = document.getElementById('welcome');
const roleTag = document.getElementById('roleTag');
const teacherModeBtn = document.getElementById('teacherModeBtn');
const gameTypeEl = document.getElementById('gameType');
const levelSelectEl = document.getElementById('levelSelect');
const startGameBtn = document.getElementById('startGameBtn');
const gameArea = document.getElementById('gameArea');
const resultArea = document.getElementById('resultArea');
const sessionScoreEl = document.getElementById('sessionScore');
const retryBtn = document.getElementById('retryBtn');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const clearScoresBtn = document.getElementById('clearScoresBtn');
const teacherTable = document.getElementById('teacherTable');
const teacherPasswordDiv = document.getElementById('teacherPasswordDiv');
const teacherPasswordInput = document.getElementById('teacherPassword');

let currentUser = null;
let currentSession = null;

// 初始化关卡
function initLevels(){
  levelSelectEl.innerHTML='';
  LEVELS.forEach((l,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=l.name;
    levelSelectEl.appendChild(opt);
  });
}
initLevels();

// 显示/隐藏教师密码
roleSelect.onchange = ()=> teacherPasswordDiv.classList.toggle('hidden', roleSelect.value!=='teacher');

// 登录
loginBtn.onclick = ()=>{
  const name = studentNameEl.value.trim();
  const role = roleSelect.value;
  if(!name){ alert('请输入姓名'); return; }
  if(role==='teacher'){
    const pwd = teacherPasswordInput.value.trim();
    if(!pwd){ alert('请输入教师密码'); return; }
    if(pwd!==TEACHER_PASSWORD){ alert('教师密码错误'); return; }
  }
  currentUser = {name, role};
  loginCard.classList.add('hidden');
  mainCard.classList.remove('hidden');
  welcomeEl.textContent = name;
  roleTag.textContent = role;
  if(role==='teacher') teacherModeBtn.classList.remove('hidden');
};

// 登出
logoutBtn.onclick = ()=> location.reload();

// 教师模式
teacherModeBtn.onclick = ()=> {
  teacherCard.classList.toggle('hidden');
  renderTeacherTable();
};

// 清空成绩
clearScoresBtn.onclick = ()=>{
  if(confirm('确定清空所有成绩吗？')) {
    scores=[];
    localStorage.removeItem('cf_scores');
    renderTeacherTable();
  }
};

// 开始闯关
startGameBtn.onclick = ()=>{
  const lvlIndex = parseInt(levelSelectEl.value);
  const gameType = gameTypeEl.value;
  startSession(lvlIndex, gameType);
};

// 工具函数
function shuffle(arr){return arr.sort(()=>Math.random()-0.5);}
function randomFrom(arr){return arr[Math.floor(Math.random()*arr.length)];}
function speak(text){const msg=new SpeechSynthesisUtterance(text); msg.lang='zh-CN'; window.speechSynthesis.speak(msg);}

// 开始关卡
function startSession(levelIndex, gameType){
  const lvl = LEVELS[levelIndex];
  const words = shuffle([...lvl.words]);
  currentSession = {levelIndex, gameType, words:words.slice(0,4), score:0, total: Math.min(4, words.length)};
  renderGame();
}

// 渲染游戏
function renderGame(){
  gameArea.innerHTML=''; resultArea.classList.add('hidden');
  const {gameType, words} = currentSession;
  if(gameType==='mc') renderMC(words);
  else if(gameType==='typing') renderTyping(words);
  else if(gameType==='listen') renderListen(words);
  else if(gameType==='match') renderMatch(words);
  else if(gameType==='pair') renderPair(words);
}

// --- renderMC / renderTyping / renderListen / renderMatch / renderPair 同原代码 ---
// 省略这里，为简洁，可直接用你原来的函数

// 完成关卡：加入练习名字
function finishSession(){
  currentSession.timestamp = new Date().toLocaleString();
  sessionScoreEl.textContent = `${currentSession.score} / ${currentSession.total}`;
  resultArea.classList.remove('hidden');

  // 新增 exercise 字段
  scores.push({
    exercise: EXERCISE_NAME,
    student: currentUser.name,
    role: currentUser.role,
    level: LEVELS[currentSession.levelIndex].name,
    gameType: currentSession.gameType,
    score: currentSession.score,
    total: currentSession.total,
    timestamp: currentSession.timestamp
  });

  localStorage.setItem('cf_scores', JSON.stringify(scores));
}

// 重玩
retryBtn.onclick=()=>renderGame();

// 教师表格
function renderTeacherTable(){
  if(scores.length===0){ teacherTable.innerHTML='无本地成绩'; return; }
  let html='<table><tr><th>练习</th><th>学生</th><th>角色</th><th>关卡</th><th>题型</th><th>得分</th><th>总分</th><th>时间</th></tr>';
  scores.forEach(s=>{
    html+=`<tr><td>${s.exercise}</td><td>${s.student}</td><td>${s.role}</td><td>${s.level}</td><td>${s.gameType}</td><td>${s.score}</td><td>${s.total}</td><td>${s.timestamp}</td></tr>`;
  });
  html+='</table>'; teacherTable.innerHTML=html;
}

// 导出 CSV
exportCsvBtn.onclick=()=>{
  if(scores.length===0){ alert('无本地成绩'); return; }
  let csv='练习,学生,角色,关卡,题型,得分,总分,时间\n';
  scores.forEach(s=>{
    csv+=`${s.exercise},${s.student},${s.role},${s.level},${s.gameType},${s.score},${s.total},${s.timestamp}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='scores.csv'; a.click(); URL.revokeObjectURL(url);
};
</script>
</body>
</html>
