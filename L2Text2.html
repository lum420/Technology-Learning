<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¯¹å¤–æ±‰è¯­æ•™å­¦å¹³å°</title>
<style>
:root{--bg:#f3f9ff;--card:#ffffff;--accent:#3b82f6;--muted:#374151}
body{font-family:"Microsoft YaHei",Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111;}
.wrap{max-width:1000px;margin:auto}
.card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 4px 15px rgba(0,0,0,.1);color:#000;}
h1,h2{margin:0 0 10px}
.muted{color:var(--muted);font-size:13px}
input,select,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d1d5db;color:#000}
button{cursor:pointer;background:var(--accent);color:#fff;border:none}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.hidden{display:none}
.options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.opt{padding:12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;color:#000;cursor:pointer}
.opt.correct{background:#d1fae5;border-color:#10b981}
.opt.wrong{background:#fee2e2;border-color:#ef4444}
.word-big{font-size:36px;margin:10px 0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border:1px solid #d1d5db;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <!-- ç™»å½• -->
  <div class="card" id="loginCard">
    <h1>ç™»å½•</h1>
    <div class="row">
      <div style="flex:1">
        <label>å§“å / å­¦å·</label><br>
        <input id="studentName" placeholder="ä¾‹å¦‚ï¼šKota / S12345">
      </div>
      <div style="width:160px">
        <label>è§’è‰²</label><br>
        <select id="roleSelect">
          <option value="student">å­¦ç”Ÿ</option>
          <option value="teacher">æ•™å¸ˆ</option>
        </select>
      </div>
      <div style="width:160px;margin-top:18px">
        <button id="loginBtn">ç™»å…¥</button>
      </div>
    </div>
    <div id="teacherPasswordDiv" class="hidden" style="margin-top:8px">
      <label>æ•™å¸ˆå¯†ç ï¼š</label><input id="teacherPassword" type="password" placeholder="è¯·è¾“å…¥å¯†ç ">
    </div>
  </div>

  <!-- æ¸¸æˆä¸»ç•Œé¢ -->
  <div class="card hidden" id="mainCard">
    <div class="row" style="justify-content:space-between">
      <div><span id="welcome" style="font-weight:700"></span> (<span id="roleTag"></span>)</div>
      <div class="row">
        <button id="logoutBtn" style="background:#ef4444">ç™»å‡º</button>
        <button id="teacherModeBtn" class="hidden" style="background:#fbbf24;color:#000">æ•™å¸ˆæ¨¡å¼</button>
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <label>é¢˜å‹ï¼š</label>
      <select id="gameType">
        <option value="mc">çœ‹è¯é€‰ä¹‰</option>
        <option value="typing">æ‹¼å†™/è¾“å…¥</option>
        <option value="listen">å¬å†™</option>
        <option value="match">é…å¯¹</option>
        <option value="pair">è¿è¿çœ‹</option>
      </select>
      <label>å…³å¡ï¼š</label>
      <select id="levelSelect"></select>
      <button id="startGameBtn">å¼€å§‹é—¯å…³</button>
    </div>

    <div id="gameArea" style="margin-top:12px"></div>
    <div id="resultArea" class="hidden">
      <h3>æœ¬æ¬¡å¾—åˆ†ï¼š<span id="sessionScore"></span></h3>
      <button id="retryBtn">é‡ç©æœ¬å…³</button>
    </div>
  </div>

  <!-- æ•™å¸ˆç•Œé¢ -->
  <div class="card hidden" id="teacherCard">
    <h2>æ•™å¸ˆæ‰¹æ”¹ä¸æˆç»©ç®¡ç†</h2>
    <button id="exportCsvBtn">å¯¼å‡º CSV</button>
    <button id="clearScoresBtn" style="background:#ef4444;margin-left:10px;">æ¸…ç©ºæˆç»©</button>
    <div id="teacherTable"></div>
  </div>
</div>

<script>
const TEACHER_PASSWORD = "NK0811";

// éŸ³æ•ˆ
const correctSound = new Audio('correct.mp3');
const wrongSound = new Audio('wrong.mp3');

const LEVELS = [
  {name:'PART1: å®¶äºº', words:[
    {ch:'çˆ¸çˆ¸', pin:'bÃ ba', en:'father'},
    {ch:'å¦ˆå¦ˆ', pin:'mÄma', en:'mother'},
    {ch:'å“¥å“¥', pin:'gÄ“ge', en:'older brother'},
    {ch:'å§å§', pin:'jiÄ›jie', en:'older sister'},
    {ch:'å¼Ÿå¼Ÿ', pin:'dÃ¬di', en:'younger brother'},
    {ch:'å¦¹å¦¹', pin:'mÃ¨imei', en:'younger sister'}
  ]},
  {name:'PART2: äº²æˆš', words:[
    {ch:'çˆ·çˆ·', pin:'yÃ©ye', en:'grandfather (fatherâ€™s side)'},
    {ch:'å¥¶å¥¶', pin:'nÇinai', en:'grandmother (fatherâ€™s side)'},
    {ch:'å¤§ä¼¯', pin:'dÃ bÃ³', en:'fatherâ€™s elder brother'},
    {ch:'å§‘å§‘', pin:'gÅ«gu', en:'fatherâ€™s sister'},
    {ch:'å”å”', pin:'shÅ«shu', en:'fatherâ€™s younger brother'},
    {ch:'èˆ…èˆ…', pin:'jiÃ¹jiu', en:'motherâ€™s brother'}
  ]}
];

let scores = JSON.parse(localStorage.getItem('cf_scores')||'[]');

const loginCard = document.getElementById('loginCard');
const mainCard = document.getElementById('mainCard');
const teacherCard = document.getElementById('teacherCard');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const studentNameEl = document.getElementById('studentName');
const roleSelect = document.getElementById('roleSelect');
const welcomeEl = document.getElementById('welcome');
const roleTag = document.getElementById('roleTag');
const teacherModeBtn = document.getElementById('teacherModeBtn');
const gameTypeEl = document.getElementById('gameType');
const levelSelectEl = document.getElementById('levelSelect');
const startGameBtn = document.getElementById('startGameBtn');
const gameArea = document.getElementById('gameArea');
const resultArea = document.getElementById('resultArea');
const sessionScoreEl = document.getElementById('sessionScore');
const retryBtn = document.getElementById('retryBtn');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const clearScoresBtn = document.getElementById('clearScoresBtn');
const teacherTable = document.getElementById('teacherTable');
const teacherPasswordDiv = document.getElementById('teacherPasswordDiv');
const teacherPasswordInput = document.getElementById('teacherPassword');

let currentUser = null;
let currentSession = null;

function initLevels(){
  levelSelectEl.innerHTML='';
  LEVELS.forEach((l,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=l.name;
    levelSelectEl.appendChild(opt);
  });
}
initLevels();

roleSelect.onchange = ()=> teacherPasswordDiv.classList.toggle('hidden', roleSelect.value!=='teacher');

loginBtn.onclick = ()=>{
  const name = studentNameEl.value.trim();
  const role = roleSelect.value;
  if(!name){ alert('è¯·è¾“å…¥å§“å'); return; }
  if(role==='teacher'){
    const pwd = teacherPasswordInput.value.trim();
    if(!pwd){ alert('è¯·è¾“å…¥æ•™å¸ˆå¯†ç '); return; }
    if(pwd!==TEACHER_PASSWORD){ alert('æ•™å¸ˆå¯†ç é”™è¯¯'); return; }
  }
  currentUser = {name, role};
  loginCard.classList.add('hidden');
  mainCard.classList.remove('hidden');
  welcomeEl.textContent = name;
  roleTag.textContent = role;
  if(role==='teacher') teacherModeBtn.classList.remove('hidden');
};

logoutBtn.onclick = ()=> location.reload();
teacherModeBtn.onclick = ()=> { teacherCard.classList.toggle('hidden'); renderTeacherTable(); };
clearScoresBtn.onclick = ()=>{
  if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æˆç»©å—ï¼Ÿ')) {
    scores=[]; localStorage.removeItem('cf_scores'); renderTeacherTable();
  }
};
startGameBtn.onclick = ()=>{ startSession(parseInt(levelSelectEl.value), gameTypeEl.value); };

function shuffle(arr){return arr.sort(()=>Math.random()-0.5);}
function randomFrom(arr){return arr[Math.floor(Math.random()*arr.length)];}
function speak(text){const msg=new SpeechSynthesisUtterance(text); msg.lang='zh-CN'; window.speechSynthesis.speak(msg);}

function startSession(levelIndex, gameType){
  const lvl = LEVELS[levelIndex];
  const words = shuffle([...lvl.words]);
  currentSession = {levelIndex, gameType, words:words.slice(0,4), score:0, total: Math.min(4, words.length)};
  renderGame();
}

function renderGame(){
  gameArea.innerHTML=''; resultArea.classList.add('hidden');
  const {gameType, words} = currentSession;
  if(gameType==='mc') renderMC(words);
  else if(gameType==='typing') renderTyping(words);
  else if(gameType==='listen') renderListen(words);
  else if(gameType==='match') renderMatch(words);
  else if(gameType==='pair') renderPair(words);
}

function finishSession(){
  currentSession.timestamp = new Date().toLocaleString();
  sessionScoreEl.textContent = `${currentSession.score} / ${currentSession.total}`;
  resultArea.classList.remove('hidden');

  const EXERCISE_NAME = location.pathname.split('/').pop().replace('.html','');
  scores.push({
    exercise: EXERCISE_NAME,
    student: currentUser.name,
    role: currentUser.role,
    level: LEVELS[currentSession.levelIndex].name,
    gameType: currentSession.gameType,
    score: currentSession.score,
    total: currentSession.total,
    timestamp: currentSession.timestamp
  });
  localStorage.setItem('cf_scores', JSON.stringify(scores));
}

retryBtn.onclick=()=>renderGame();

function renderTeacherTable(){
  if(scores.length===0){ teacherTable.innerHTML='æ— æœ¬åœ°æˆç»©'; return; }
  let html='<table><tr><th>ç»ƒä¹ </th><th>å­¦ç”Ÿ</th><th>è§’è‰²</th><th>å…³å¡</th><th>é¢˜å‹</th><th>å¾—åˆ†</th><th>æ€»åˆ†</th><th>æ—¶é—´</th></tr>';
  scores.forEach(s=>{
    html+=`<tr>
      <td>${s.exercise}</td>
      <td>${s.student}</td>
      <td>${s.role}</td>
      <td>${s.level}</td>
      <td>${s.gameType}</td>
      <td>${s.score}</td>
      <td>${s.total}</td>
      <td>${s.timestamp}</td>
    </tr>`;
  });
  html+='</table>';
  teacherTable.innerHTML=html;
}

exportCsvBtn.onclick=()=>{
  if(scores.length===0){ alert('æ— æ•°æ®å¯å¯¼å‡º'); return; }
  const header=['ç»ƒä¹ ','å­¦ç”Ÿ','è§’è‰²','å…³å¡','é¢˜å‹','å¾—åˆ†','æ€»åˆ†','æ—¶é—´'];
  const rows=scores.map(s=>[s.exercise,s.student,s.role,s.level,s.gameType,s.score,s.total,s.timestamp]);
  const csv=[header,...rows].map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='scores.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ===== å„é¢˜å‹å®ç° ===== */
// çœ‹è¯é€‰ä¹‰
function renderMC(words){
  let idx=0; const box=document.createElement('div');
  box.innerHTML=`<div class="muted">çœ‹è¯é€‰ä¹‰ (${words.length} é¢˜)</div>`; gameArea.appendChild(box);

  const showQ=()=>{
    box.querySelectorAll('.q').forEach(n=>n.remove());
    if(idx>=words.length){ finishSession(); return; }
    const w=words[idx]; const q=document.createElement('div'); q.className='q';
    q.innerHTML=`<div class="word-big">${w.ch}</div><div class="muted">${w.pin}</div>`;
    
    const opts=[w.en]; while(opts.length<4){ const r=randomFrom(words).en; if(!opts.includes(r)) opts.push(r); } shuffle(opts);
    const optsBox=document.createElement('div'); optsBox.className='options';
    opts.forEach(o=>{
      const b=document.createElement('button'); b.className='opt'; b.textContent=o;
      b.onclick=()=>{
        if(o===w.en){ b.classList.add('correct'); currentSession.score++; correctSound.play(); }
        else { b.classList.add('wrong'); wrongSound.play(); const right=[...optsBox.children].find(x=>x.textContent===w.en); if(right) right.classList.add('correct'); }
        idx++; setTimeout(showQ,1000);
      };
      optsBox.appendChild(b);
    });

    const speakBtn=document.createElement('button'); speakBtn.textContent='ğŸ”Š å‘éŸ³'; speakBtn.style.marginLeft='8px';
    speakBtn.onclick=()=>speak(w.ch); q.appendChild(speakBtn);

    q.appendChild(optsBox); box.appendChild(q);
  }; showQ();
}

// æ‹¼å†™/è¾“å…¥
function renderTyping(words){
  let idx=0; const box=document.createElement('div');
  box.innerHTML=`<div class="muted">æ‹¼å†™/è¾“å…¥ (${words.length} é¢˜)</div>`; gameArea.appendChild(box);

  const showQ=()=>{
    box.querySelectorAll('.q').forEach(n=>n.remove());
    if(idx>=words.length){ finishSession(); return; }
    const w=words[idx]; const q=document.createElement('div'); q.className='q';
    q.innerHTML=`<div class="word-big">${w.ch}</div><div class="muted">${w.pin}</div>`;
    const inp=document.createElement('input'); inp.style.width='100%'; inp.placeholder='è¾“å…¥ç­”æ¡ˆå¹¶å›è½¦';
    inp.onkeydown=(e)=>{
      if(e.key==='Enter'){
        const val=inp.value.trim().toLowerCase();
        if(val===w.ch.toLowerCase()||val===w.en.toLowerCase()||val===w.pin.toLowerCase()){ currentSession.score++; correctSound.play(); }
        else { wrongSound.play(); alert(`æ­£ç¡®ç­”æ¡ˆ: ${w.ch} / ${w.en} / ${w.pin}`); }
        idx++; setTimeout(showQ,600);
      }
    };
    q.appendChild(inp); box.appendChild(q); inp.focus();
  }; showQ();
}

// å¬å†™
function renderListen(words){
  let idx=0; const box=document.createElement('div');
  box.innerHTML=`<div class="muted">å¬å†™ (${words.length} é¢˜)</div>`; gameArea.appendChild(box);
  const showQ=()=>{
    box.querySelectorAll('.q').forEach(n=>n.remove());
    if(idx>=words.length){ finishSession(); return; }
    const w=words[idx]; const q=document.createElement('div'); q.className='q';
    const playBtn=document.createElement('button'); playBtn.textContent='ğŸ”Š æ’­æ”¾'; playBtn.onclick=()=>speak(w.ch); q.appendChild(playBtn);
    const inp=document.createElement('input'); inp.style.width='100%'; inp.placeholder='è¾“å…¥ç­”æ¡ˆå¹¶å›è½¦';
    inp.onkeydown=(e)=>{
      if(e.key==='Enter'){
        const val=inp.value.trim().toLowerCase();
        if(val===w.ch.toLowerCase()||val===w.en.toLowerCase()||val===w.pin.toLowerCase()){ currentSession.score++; correctSound.play(); }
        else { wrongSound.play(); alert(`æ­£ç¡®ç­”æ¡ˆ: ${w.ch} / ${w.en} / ${w.pin}`); }
        idx++; setTimeout(showQ,600);
      }
    };
    q.appendChild(inp); box.appendChild(q); inp.focus();
  }; showQ();
}

// é…å¯¹
function renderMatch(words){
  currentSession.score=0;
  const box=document.createElement('div'); box.innerHTML=`<div class="muted">é…å¯¹é¢˜ï¼šç‚¹å‡»å·¦åˆ—ä¸­æ–‡ï¼Œå†ç‚¹å‡»å³åˆ—è‹±æ–‡</div>`; gameArea.appendChild(box);
  let selected=null, correctPairs=0;
  const left=words.map(w=>({id:w.ch,text:w.ch})), right=shuffle(words.map(w=>({id:w.ch,text:w.en})));
  const leftBox=document.createElement('div'); leftBox.style.width='45%'; leftBox.style.display='inline-block';
  const rightBox=document.createElement('div'); rightBox.style.width='45%'; rightBox.style.display='inline-block';
  left.forEach(l=>{
    const b=document.createElement('button'); b.className='opt'; b.style.display='block'; b.style.width='100%'; b.style.marginBottom='6px'; b.textContent=l.text;
    b.onclick=()=>{ selected=l; b.style.border='2px solid #3b82f6'; }; leftBox.appendChild(b);
  });
  right.forEach(r=>{
    const b=document.createElement('button'); b.className='opt'; b.style.display='block'; b.style.width='100%'; b.style.marginBottom='6px'; b.textContent=r.text;
    b.onclick=()=>{
      if(!selected) return;
      const correctId = r.id;
      if(selected.id===correctId){ currentSession.score++; correctSound.play(); correctPairs++; b.classList.add('correct'); }
      else { wrongSound.play(); alert(`æ­£ç¡®é…å¯¹: ${selected.text} - ${LEVELS[currentSession.levelIndex].words.find(x=>x.ch===selected.id).en}`); }
      selected=null;
      if(correctPairs>=words.length){ finishSession(); }
    };
    rightBox.appendChild(b);
  });
  box.appendChild(leftBox); box.appendChild(rightBox); gameArea.appendChild(box);
}

// è¿è¿çœ‹
function renderPair(words){
  currentSession.score=0;
  const box=document.createElement('div'); box.innerHTML=`<div class="muted">è¿è¿çœ‹ï¼šç‚¹å‡»ä¸¤ä¸ªæŒ‰é’®é…å¯¹</div>`; gameArea.appendChild(box);
  let first=null, correctPairs=0;
  const buttons = shuffle([...words,...words]).map(w=>({id:w.ch,text:w.ch}));
  const btnBox=document.createElement('div'); btnBox.className='options';
  buttons.forEach(b=>{
    const btn=document.createElement('button'); btn.className='opt'; btn.textContent=b.text;
    btn.onclick=()=>{
      if(!first){ first={btn,b}; btn.style.border='2px solid #3b82f6'; return; }
      if(first.b.id===b.id && first.btn!==btn){ currentSession.score++; correctSound.play(); first.btn.classList.add('correct'); btn.classList.add('correct'); correctPairs++; }
      else { wrongSound.play(); alert(`æ­£ç¡®ç­”æ¡ˆ: ${LEVELS[currentSession.levelIndex].words.find(x=>x.ch===b.id).ch}`); }
      first=null;
      if(correctPairs>=words.length){ finishSession(); }
    };
    btnBox.appendChild(btn);
  });
  box.appendChild(btnBox);
}
</script>
</body>
</html>
